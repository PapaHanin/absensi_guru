<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Digital Guru Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .calendar-cell { transition: all 0.2s ease; }
        .calendar-cell:hover { transform: scale(1.02); }
        .status-hadir { background: linear-gradient(135deg, #10b981, #059669); }
        .status-izin { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-sakit { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-alpha { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .status-terlambat { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .status-pulang-cepat { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .teacher-card { transition: all 0.3s ease; }
        .teacher-card:hover { transform: translateY(-2px); }
        .teacher-selected { border: 2px solid #3b82f6; background: #eff6ff; }
        .license-expired { filter: grayscale(100%); pointer-events: none; }
        .license-warning { background: linear-gradient(45deg, #fbbf24, #f59e0b); }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden" style="background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 25%, #1e40af 50%, #2563eb 75%, #3b82f6 100%);">
    <!-- School Background Elements -->
    <div class="fixed inset-0 pointer-events-none opacity-10">
        <!-- Books -->
        <div class="absolute top-10 left-10 text-6xl transform rotate-12">📚</div>
        <div class="absolute top-32 right-20 text-5xl transform -rotate-12">📖</div>
        <div class="absolute bottom-40 left-16 text-4xl transform rotate-45">📝</div>
        
        <!-- School Items -->
        <div class="absolute top-20 right-40 text-5xl transform rotate-6">🎓</div>
        <div class="absolute bottom-20 right-10 text-6xl transform -rotate-12">🏫</div>
        <div class="absolute top-1/2 left-5 text-4xl transform rotate-12">✏️</div>
        
        <!-- Educational Icons -->
        <div class="absolute top-1/3 right-1/4 text-5xl transform -rotate-6">🔬</div>
        <div class="absolute bottom-1/3 left-1/3 text-4xl transform rotate-30">📐</div>
        <div class="absolute top-2/3 right-1/3 text-5xl transform -rotate-15">🧮</div>
        
        <!-- Additional School Elements -->
        <div class="absolute top-16 left-1/2 text-4xl transform rotate-20">🖊️</div>
        <div class="absolute bottom-32 left-1/4 text-5xl transform -rotate-20">📊</div>
        <div class="absolute top-1/4 left-1/4 text-4xl transform rotate-45">🎯</div>
    </div>
    
    <!-- Subtle Pattern Overlay -->
    <div class="fixed inset-0 pointer-events-none opacity-5" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.1) 35px, rgba(255,255,255,.1) 70px);"></div>
    <!-- License Check Modal -->
    <div id="licenseModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 m-4 max-w-md w-full text-center">
            <div class="text-6xl mb-4">🔒</div>
            <h3 class="text-2xl font-bold text-red-600 mb-4">Lisensi Expired!</h3>
            <p class="text-gray-600 mb-6">Aplikasi ini memerlukan lisensi yang valid untuk digunakan. Silakan hubungi administrator untuk perpanjangan lisensi.</p>
            <div class="text-sm text-gray-500">
                <p>Tanggal Expire: <span id="expireDate" class="font-semibold"></span></p>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8" id="mainApp">
        <!-- Header with License Info -->
        <div class="bg-gradient-to-r from-blue-900/90 to-indigo-900/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-8 border border-blue-300/30">
            <div class="flex flex-col lg:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 mb-2">📚 Absensi Digital Guru Pro</h1>
                    <p class="text-gray-300">Sistem manajemen kehadiran guru yang lengkap dan profesional</p>
                </div>
                <div class="flex flex-col items-end mt-4 lg:mt-0">
                    <div id="licenseInfo" class="text-sm mb-3 px-3 py-1 rounded-full">
                        <span id="licenseStatus"></span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <div id="saveStatus" class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-green-100 text-green-800">
                            <span class="animate-pulse">💾</span>
                            <span id="saveStatusText">Tersimpan otomatis</span>
                        </div>
                        <button onclick="downloadPDF()" class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 text-sm shadow-lg hover:shadow-orange-500/25">
                            📄 PDF
                        </button>
                        <button onclick="exportToSpreadsheet()" class="bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 text-sm shadow-lg hover:shadow-emerald-500/25">
                            📊 Excel
                        </button>
                        <button onclick="backupData()" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 text-sm shadow-lg hover:shadow-cyan-500/25">
                            💾 Backup
                        </button>
                        <button onclick="document.getElementById('restoreFile').click()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 text-sm shadow-lg hover:shadow-purple-500/25">
                            🔄 Restore
                        </button>
                        <button onclick="showAllTeachersRecap()" class="bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-700 hover:to-cyan-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 text-sm shadow-lg hover:shadow-teal-500/25">
                            📋 Rekap Semua
                        </button>
                        <button onclick="showSettings()" class="bg-gradient-to-r from-slate-600 to-gray-600 hover:from-slate-700 hover:to-gray-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 text-sm shadow-lg hover:shadow-slate-500/25">
                            ⚙️ Setting
                        </button>
                        <button onclick="debugData()" class="bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-700 hover:to-rose-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 text-sm shadow-lg hover:shadow-pink-500/25">
                            🔍 Debug
                        </button>
                        <button onclick="testSaveLoad()" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 text-sm shadow-lg hover:shadow-indigo-500/25">
                            🧪 Test Save
                        </button>
                        <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData(event)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Management -->
        <div class="bg-gradient-to-r from-blue-900/90 to-indigo-900/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-8 border border-blue-300/30">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400">👥 Manajemen Guru</h2>
                <div class="flex gap-3 mt-4 md:mt-0">
                    <button onclick="showAddTeacher()" class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 shadow-lg hover:shadow-orange-500/25">
                        ➕ Tambah Guru
                    </button>
                    <button onclick="importTeachers()" class="bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 shadow-lg hover:shadow-emerald-500/25">
                        📥 Import Guru
                    </button>
                </div>
            </div>
            <div id="teacherList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Teacher cards will be generated here -->
            </div>
        </div>

        <!-- Controls -->
        <div class="bg-gradient-to-r from-blue-900/90 to-indigo-900/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-8 border border-blue-300/30">
            <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex items-center gap-3">
                        <label class="font-semibold text-yellow-300">Bulan:</label>
                        <select id="monthSelect" onchange="updateCalendar()" class="bg-blue-800/80 border border-blue-300/30 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="font-semibold text-yellow-300">Tahun:</label>
                        <select id="yearSelect" onchange="updateCalendar()" class="bg-blue-800/80 border border-blue-300/30 text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="font-semibold text-yellow-300">Guru Terpilih:</span>
                    <span id="selectedTeacherName" class="px-3 py-1 bg-gradient-to-r from-orange-600 to-red-600 text-white rounded-full text-sm shadow-lg">Belum dipilih</span>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="bg-gradient-to-r from-blue-900/90 to-indigo-900/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-8 border border-blue-300/30">
            <h3 class="font-semibold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 mb-4">Keterangan Status:</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded status-hadir"></div>
                    <span class="text-sm text-gray-300">Hadir</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded status-izin"></div>
                    <span class="text-sm text-gray-300">Izin</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded status-sakit"></div>
                    <span class="text-sm text-gray-300">Sakit</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded status-alpha"></div>
                    <span class="text-sm text-gray-300">Alpha</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded status-terlambat"></div>
                    <span class="text-sm text-gray-300">Terlambat</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded status-pulang-cepat"></div>
                    <span class="text-sm text-gray-300">Pulang Cepat</span>
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="bg-gradient-to-r from-blue-900/90 to-indigo-900/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-8 border border-blue-300/30">
            <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 mb-6 text-center" id="calendarTitle">Pilih Guru Terlebih Dahulu</h2>
            <div id="calendarContainer" class="hidden">
                <div class="grid grid-cols-7 gap-2 mb-4">
                    <div class="text-center font-semibold text-yellow-300 py-2">Min</div>
                    <div class="text-center font-semibold text-yellow-300 py-2">Sen</div>
                    <div class="text-center font-semibold text-yellow-300 py-2">Sel</div>
                    <div class="text-center font-semibold text-yellow-300 py-2">Rab</div>
                    <div class="text-center font-semibold text-yellow-300 py-2">Kam</div>
                    <div class="text-center font-semibold text-yellow-300 py-2">Jum</div>
                    <div class="text-center font-semibold text-yellow-300 py-2">Sab</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                    <!-- Calendar cells will be generated here -->
                </div>
            </div>
            <div id="noTeacherSelected" class="text-center py-12">
                <div class="text-6xl mb-4">👨‍🏫</div>
                <p class="text-blue-200 text-lg">Silakan pilih guru dari daftar di atas untuk mulai mengisi absensi</p>
            </div>
        </div>

        <!-- Statistics -->
        <div class="bg-gradient-to-r from-blue-900/90 to-indigo-900/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 mb-8 border border-blue-300/30">
            <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 mb-4">📊 Statistik Kehadiran</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="statistics">
                <div class="text-center p-4 bg-green-900/50 backdrop-blur-sm rounded-lg border border-green-400/30">
                    <div class="text-2xl font-bold text-green-300" id="hadirCount">0</div>
                    <div class="text-sm text-green-200">Hadir</div>
                </div>
                <div class="text-center p-4 bg-yellow-900/50 backdrop-blur-sm rounded-lg border border-yellow-400/30">
                    <div class="text-2xl font-bold text-yellow-300" id="izinCount">0</div>
                    <div class="text-sm text-yellow-200">Izin</div>
                </div>
                <div class="text-center p-4 bg-red-900/50 backdrop-blur-sm rounded-lg border border-red-400/30">
                    <div class="text-2xl font-bold text-red-300" id="sakitCount">0</div>
                    <div class="text-sm text-red-200">Sakit</div>
                </div>
                <div class="text-center p-4 bg-gray-900/50 backdrop-blur-sm rounded-lg border border-gray-400/30">
                    <div class="text-2xl font-bold text-gray-300" id="alphaCount">0</div>
                    <div class="text-sm text-gray-200">Alpha</div>
                </div>
                <div class="text-center p-4 bg-purple-900/50 backdrop-blur-sm rounded-lg border border-purple-400/30">
                    <div class="text-2xl font-bold text-purple-300" id="terlambatCount">0</div>
                    <div class="text-sm text-purple-200">Terlambat</div>
                </div>
                <div class="text-center p-4 bg-cyan-900/50 backdrop-blur-sm rounded-lg border border-cyan-400/30">
                    <div class="text-2xl font-bold text-cyan-300" id="pulangCepatCount">0</div>
                    <div class="text-sm text-cyan-200">Pulang Cepat</div>
                </div>
            </div>
            <div class="mt-6 p-4 bg-orange-900/50 backdrop-blur-sm rounded-lg border border-orange-400/30">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-orange-200">Persentase Kehadiran:</span>
                    <span class="text-2xl font-bold text-orange-300" id="attendancePercentage">0%</span>
                </div>
            </div>
        </div>

        <!-- Monthly Recap -->
        <div id="monthlyRecap" class="bg-gradient-to-r from-blue-900/90 to-indigo-900/90 backdrop-blur-sm rounded-2xl shadow-2xl p-6 border border-blue-300/30 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400">📈 Rekap Persentase Bulanan</h3>
                <button onclick="downloadMonthlyRecap()" class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 shadow-lg hover:shadow-orange-500/25">
                    📊 Download Rekap
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4" id="monthlyStats">
                <!-- Monthly stats will be generated here -->
            </div>
            <div class="mt-6 p-4 bg-gradient-to-r from-orange-900/50 to-yellow-900/50 backdrop-blur-sm rounded-lg border border-orange-400/30">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-orange-200">Rata-rata Kehadiran Tahunan:</span>
                    <span class="text-2xl font-bold text-orange-300" id="yearlyAverage">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for attendance -->
    <div id="attendanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 m-4 max-w-lg w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="modalTitle">Absensi Tanggal</h3>
            
            <!-- Current Status Display -->
            <div id="currentStatus" class="hidden mb-4 p-3 rounded-lg border-l-4">
                <div class="flex items-center justify-between">
                    <div>
                        <span class="font-medium">Status saat ini: </span>
                        <span id="currentStatusText" class="font-bold"></span>
                    </div>
                    <button onclick="editCurrentStatus()" class="text-blue-500 hover:text-blue-700 text-sm">✏️ Edit</button>
                </div>
                <div id="currentNote" class="text-sm text-gray-600 mt-1"></div>
            </div>

            <div id="statusSelection" class="space-y-3">
                <button onclick="selectStatus('hadir')" class="w-full p-3 text-left rounded-lg border-2 border-green-200 hover:border-green-400 hover:bg-green-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded status-hadir"></div>
                        <span class="font-medium">Hadir</span>
                    </div>
                </button>
                <button onclick="selectStatus('izin')" class="w-full p-3 text-left rounded-lg border-2 border-yellow-200 hover:border-yellow-400 hover:bg-yellow-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded status-izin"></div>
                        <span class="font-medium">Izin</span>
                    </div>
                </button>
                <button onclick="selectStatus('sakit')" class="w-full p-3 text-left rounded-lg border-2 border-red-200 hover:border-red-400 hover:bg-red-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded status-sakit"></div>
                        <span class="font-medium">Sakit</span>
                    </div>
                </button>
                <button onclick="selectStatus('alpha')" class="w-full p-3 text-left rounded-lg border-2 border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded status-alpha"></div>
                        <span class="font-medium">Alpha</span>
                    </div>
                </button>
                <button onclick="selectStatus('terlambat')" class="w-full p-3 text-left rounded-lg border-2 border-purple-200 hover:border-purple-400 hover:bg-purple-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded status-terlambat"></div>
                        <span class="font-medium">Terlambat</span>
                    </div>
                </button>
                <button onclick="selectStatus('pulang-cepat')" class="w-full p-3 text-left rounded-lg border-2 border-cyan-200 hover:border-cyan-400 hover:bg-cyan-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded status-pulang-cepat"></div>
                        <span class="font-medium">Pulang Cepat</span>
                    </div>
                </button>
            </div>

            <!-- Note Input -->
            <div id="noteSection" class="hidden mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan (Opsional)</label>
                <textarea id="attendanceNote" placeholder="Tambahkan keterangan..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" rows="3"></textarea>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Batal</button>
                <button id="saveBtn" onclick="saveAttendance()" class="hidden flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Simpan</button>
                <button onclick="clearAttendance()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Add Teacher Modal -->
    <div id="addTeacherModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 m-4 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Tambah Guru Baru</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="newTeacherName" placeholder="Masukkan nama lengkap" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                    <input type="text" id="newTeacherNIP" placeholder="Masukkan NIP" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                    <input type="text" id="newTeacherSubject" placeholder="Masukkan mata pelajaran / Kelas Berapa " class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddTeacher()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Batal</button>
                <button onclick="addTeacher()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Tambah</button>
            </div>
        </div>
    </div>

    <!-- All Teachers Recap Modal -->
    <div id="allTeachersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 m-4 max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">📋 Rekap Kehadiran Semua Guru</h3>
                <div class="flex gap-3">
                    <button onclick="downloadAllTeachersPDF()" class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 shadow-lg">
                        📄 Download PDF
                    </button>
                    <button onclick="exportAllTeachersCSV()" class="bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all duration-300 shadow-lg">
                        📊 Export CSV
                    </button>
                    <button onclick="closeAllTeachersRecap()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ✕ Tutup
                    </button>
                </div>
            </div>
            
            <!-- Period Selection -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex items-center gap-2">
                        <label class="font-medium text-gray-700">Bulan:</label>
                        <select id="recapMonthSelect" onchange="updateAllTeachersRecap()" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Maret</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Juni</option>
                            <option value="6">Juli</option>
                            <option value="7">Agustus</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Desember</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="font-medium text-gray-700">Tahun:</label>
                        <select id="recapYearSelect" onchange="updateAllTeachersRecap()" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-medium text-gray-700">Total Guru:</span>
                        <span id="totalTeachersCount" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">0</span>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600" id="totalHadirAll">0</div>
                    <div class="text-sm text-green-700">Total Hadir</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="totalIzinAll">0</div>
                    <div class="text-sm text-yellow-700">Total Izin</div>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-600" id="totalSakitAll">0</div>
                    <div class="text-sm text-red-700">Total Sakit</div>
                </div>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-gray-600" id="totalAlphaAll">0</div>
                    <div class="text-sm text-gray-700">Total Alpha</div>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-purple-600" id="totalTerlambatAll">0</div>
                    <div class="text-sm text-purple-700">Total Terlambat</div>
                </div>
                <div class="bg-cyan-50 border border-cyan-200 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-cyan-600" id="totalPulangCepatAll">0</div>
                    <div class="text-sm text-cyan-700">Total P.Cepat</div>
                </div>
            </div>

            <!-- Teachers Table -->
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Guru</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIP</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Izin</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Sakit</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Terlambat</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">P.Cepat</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Persentase</th>
                            </tr>
                        </thead>
                        <tbody id="allTeachersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be generated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Overall Statistics -->
            <div class="mt-6 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">📊 Statistik Keseluruhan</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="overallAttendanceRate">0%</div>
                        <div class="text-sm text-gray-600">Rata-rata Kehadiran</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="bestPerformingTeacher">-</div>
                        <div class="text-sm text-gray-600">Guru Terbaik</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-orange-600" id="teachersNeedAttention">0</div>
                        <div class="text-sm text-gray-600">Perlu Perhatian (&lt;75%)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 m-4 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">⚙️ Pengaturan Lisensi</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Expire Lisensi</label>
                    <input type="date" id="licenseExpireDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg">
                    <p class="text-sm text-yellow-800">
                        <strong>Catatan:</strong> Setelah tanggal expire, aplikasi akan terkunci dan tidak dapat digunakan.
                    </p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeSettings()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Batal</button>
                <button onclick="updateLicense()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">Update</button>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let attendanceData = {};
        let teachersData = [];
        let currentDate = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedTeacher = null;
        let licenseExpireDate = null;
        let autoSaveInterval = null;
        let lastSaveTime = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('=== MEMULAI INISIALISASI APLIKASI ===');
                
                checkLicense();
                document.getElementById('monthSelect').value = currentMonth;
                document.getElementById('yearSelect').value = currentYear;
                
                // Load data dengan verifikasi lengkap
                console.log('1. Loading attendance data...');
                loadData();
                console.log('   Attendance data loaded:', Object.keys(attendanceData).length, 'records');
                
                console.log('2. Loading teachers data...');
                loadTeachers();
                console.log('   Teachers data loaded:', teachersData.length, 'teachers');
                
                console.log('3. Loading selected teacher...');
                loadSelectedTeacher();
                console.log('   Selected teacher:', selectedTeacher ? selectedTeacher.name : 'None');
                
                // Update UI setelah semua data dimuat
                console.log('4. Updating UI...');
                updateTeacherList();
                
                if (selectedTeacher) {
                    console.log('5. Updating calendar for selected teacher...');
                    updateCalendar();
                    updateStatistics();
                    updateMonthlyRecap();
                    
                    // Verifikasi data absensi untuk guru terpilih
                    const teacherAttendanceKeys = Object.keys(attendanceData).filter(key => 
                        key.startsWith(`${selectedTeacher.id}-`)
                    );
                    console.log(`   Found ${teacherAttendanceKeys.length} attendance records for ${selectedTeacher.name}`);
                    
                    if (teacherAttendanceKeys.length > 0) {
                        console.log('   Sample records:', teacherAttendanceKeys.slice(0, 3).map(key => ({
                            key, 
                            value: attendanceData[key]
                        })));
                    }
                }
                
                initAutoSave();
                updateSaveStatus('loaded');
                
                console.log('=== INISIALISASI SELESAI ===');
                console.log('Final state:', {
                    attendanceCount: Object.keys(attendanceData).length,
                    teachersCount: teachersData.length,
                    selectedTeacher: selectedTeacher ? selectedTeacher.name : 'None',
                    currentMonth: currentMonth,
                    currentYear: currentYear
                });
                
                // Test penyimpanan untuk memastikan localStorage berfungsi
                testLocalStorage();
                
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Error saat memuat aplikasi. Silakan refresh halaman.');
            }
        });

        // Test fungsi localStorage
        function testLocalStorage() {
            try {
                const testKey = 'test-' + Date.now();
                const testValue = 'test-value';
                
                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (retrieved === testValue) {
                    console.log('✅ localStorage test: BERHASIL');
                } else {
                    console.error('❌ localStorage test: GAGAL - nilai tidak sama');
                }
            } catch (error) {
                console.error('❌ localStorage test: ERROR -', error);
                alert('Peringatan: Penyimpanan data mungkin tidak berfungsi dengan baik!');
            }
        }

        // Auto-save system
        function initAutoSave() {
            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(() => {
                saveAllData();
                updateSaveStatus('auto');
            }, 30000);

            // Save when page is about to close
            window.addEventListener('beforeunload', function() {
                saveAllData();
            });

            // Save when page loses focus
            window.addEventListener('blur', function() {
                saveAllData();
            });

            // Save when visibility changes (tab switching)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    saveAllData();
                }
            });
        }

        function saveAllData() {
            try {
                saveData();
                saveTeachers();
                saveSelectedTeacher();
                lastSaveTime = new Date();
                localStorage.setItem('lastSaveTime', lastSaveTime.toISOString());
                
                // Debug log to verify save
                console.log('Data saved:', {
                    attendanceCount: Object.keys(attendanceData).length,
                    teachersCount: teachersData.length,
                    selectedTeacher: selectedTeacher ? selectedTeacher.name : 'None',
                    timestamp: lastSaveTime.toISOString()
                });
            } catch (error) {
                console.error('Save error:', error);
                updateSaveStatus('error');
            }
        }

        function updateSaveStatus(type) {
            const saveStatus = document.getElementById('saveStatus');
            const saveStatusText = document.getElementById('saveStatusText');
            
            if (!saveStatus || !saveStatusText) return;

            switch (type) {
                case 'saving':
                    saveStatus.className = 'flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-yellow-100 text-yellow-800';
                    saveStatusText.textContent = 'Menyimpan...';
                    break;
                case 'saved':
                    saveStatus.className = 'flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-green-100 text-green-800';
                    saveStatusText.textContent = 'Tersimpan';
                    setTimeout(() => {
                        if (saveStatusText.textContent === 'Tersimpan') {
                            saveStatusText.textContent = 'Tersimpan otomatis';
                        }
                    }, 2000);
                    break;
                case 'auto':
                    saveStatus.className = 'flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-blue-100 text-blue-800';
                    saveStatusText.textContent = `Disimpan ${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}`;
                    break;
                case 'loaded':
                    const lastSave = localStorage.getItem('lastSaveTime');
                    if (lastSave) {
                        const lastSaveDate = new Date(lastSave);
                        const today = new Date();
                        const isToday = lastSaveDate.toDateString() === today.toDateString();
                        
                        saveStatus.className = 'flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-green-100 text-green-800';
                        if (isToday) {
                            saveStatusText.textContent = `Data dimuat (${lastSaveDate.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})})`;
                        } else {
                            saveStatusText.textContent = `Data dimuat (${lastSaveDate.toLocaleDateString('id-ID')})`;
                        }
                    } else {
                        saveStatus.className = 'flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-gray-100 text-gray-800';
                        saveStatusText.textContent = 'Data baru';
                    }
                    break;
                case 'error':
                    saveStatus.className = 'flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-red-100 text-red-800';
                    saveStatusText.textContent = 'Error menyimpan';
                    break;
                default:
                    saveStatus.className = 'flex items-center gap-2 px-3 py-2 rounded-lg text-sm bg-green-100 text-green-800';
                    saveStatusText.textContent = 'Tersimpan otomatis';
            }
        }

        // License Management
        function checkLicense() {
            const savedExpire = localStorage.getItem('licenseExpire');
            if (savedExpire) {
                licenseExpireDate = new Date(savedExpire);
            } else {
                // Default 30 days from now
                licenseExpireDate = new Date();
                licenseExpireDate.setDate(licenseExpireDate.getDate() + 30);
                localStorage.setItem('licenseExpire', licenseExpireDate.toISOString());
            }

            const now = new Date();
            const daysLeft = Math.ceil((licenseExpireDate - now) / (1000 * 60 * 60 * 24));
            
            const licenseInfo = document.getElementById('licenseInfo');
            const licenseStatus = document.getElementById('licenseStatus');
            
            if (daysLeft <= 0) {
                // License expired
                licenseStatus.textContent = 'Lisensi Expired';
                licenseInfo.className = 'text-sm mb-3 px-3 py-1 rounded-full bg-red-100 text-red-800';
                document.getElementById('mainApp').classList.add('license-expired');
                document.getElementById('expireDate').textContent = licenseExpireDate.toLocaleDateString('id-ID');
                document.getElementById('licenseModal').classList.remove('hidden');
                document.getElementById('licenseModal').classList.add('flex');
                return false;
            } else if (daysLeft <= 7) {
                // Warning
                licenseStatus.textContent = `Expire dalam ${daysLeft} hari`;
                licenseInfo.className = 'text-sm mb-3 px-3 py-1 rounded-full license-warning text-white';
            } else {
                // Valid
                licenseStatus.textContent = `Aktif hingga ${licenseExpireDate.toLocaleDateString('id-ID')}`;
                licenseInfo.className = 'text-sm mb-3 px-3 py-1 rounded-full bg-green-100 text-green-800';
            }
            return true;
        }

        function showSettings() {
            document.getElementById('licenseExpireDate').value = licenseExpireDate.toISOString().split('T')[0];
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }

        function updateLicense() {
            const newDate = document.getElementById('licenseExpireDate').value;
            if (newDate) {
                licenseExpireDate = new Date(newDate);
                localStorage.setItem('licenseExpire', licenseExpireDate.toISOString());
                checkLicense();
                closeSettings();
                alert('Lisensi berhasil diperbarui!');
            }
        }

        // Teacher Management
        function loadTeachers() {
            try {
                const saved = localStorage.getItem('teachersData');
                if (saved && saved !== 'undefined' && saved !== 'null') {
                    teachersData = JSON.parse(saved);
                    console.log('Teachers data loaded from localStorage:', teachersData.length, 'teachers');
                } else {
                    // Default teachers
                    teachersData = [
                        { id: 1, name: 'Siti Nurhaliza, S.Pd', nip: '196801011990032001', subject: 'Matematika' },
                        { id: 2, name: 'Ahmad Fauzi, S.Pd', nip: '197205151995121002', subject: 'Bahasa Indonesia' },
                        { id: 3, name: 'Dewi Sartika, S.Pd', nip: '198003201998032003', subject: 'IPA' },
                        { id: 4, name: 'Budi Santoso, S.Pd', nip: '197512101999031004', subject: 'IPS' },
                        { id: 5, name: 'Rina Marlina, S.Pd', nip: '198506252005012005', subject: 'Bahasa Inggris' },
                        { id: 6, name: 'Hendra Wijaya, S.Pd', nip: '197909152000121006', subject: 'Pendidikan Jasmani' }
                    ];
                    console.log('No teachers data found, using default teachers');
                    saveTeachers();
                }
            } catch (error) {
                console.error('Error loading teachers data:', error);
                teachersData = [];
            }
        }

        function saveTeachers() {
            try {
                const dataToSave = JSON.stringify(teachersData);
                localStorage.setItem('teachersData', dataToSave);
                console.log('Teachers data saved to localStorage:', teachersData.length, 'teachers');
            } catch (error) {
                console.error('Error saving teachers data:', error);
            }
        }

        function updateTeacherList() {
            const teacherList = document.getElementById('teacherList');
            teacherList.innerHTML = '';

            teachersData.forEach(teacher => {
                const card = document.createElement('div');
                card.className = `teacher-card p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:shadow-md transition-all ${selectedTeacher && selectedTeacher.id === teacher.id ? 'teacher-selected' : ''}`;
                card.onclick = () => selectTeacher(teacher);
                
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold text-gray-800 text-sm">${teacher.name}</h4>
                        <button onclick="deleteTeacher(${teacher.id}); event.stopPropagation();" class="text-red-500 hover:text-red-700 text-xs">
                            🗑️
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 mb-1">NIP: ${teacher.nip}</p>
                    <p class="text-xs text-blue-600 font-medium">${teacher.subject}</p>
                `;
                
                teacherList.appendChild(card);
            });
        }

        function selectTeacher(teacher) {
            selectedTeacher = teacher;
            document.getElementById('selectedTeacherName').textContent = teacher.name;
            document.getElementById('calendarContainer').classList.remove('hidden');
            document.getElementById('noTeacherSelected').classList.add('hidden');
            updateTeacherList();
            updateCalendar();
            updateMonthlyRecap();
            saveSelectedTeacher();
            updateSaveStatus('saved');
        }

        function saveSelectedTeacher() {
            try {
                if (selectedTeacher) {
                    localStorage.setItem('selectedTeacher', JSON.stringify(selectedTeacher));
                    console.log('Selected teacher saved:', selectedTeacher.name);
                } else {
                    localStorage.removeItem('selectedTeacher');
                    console.log('Selected teacher cleared');
                }
            } catch (error) {
                console.error('Error saving selected teacher:', error);
            }
        }

        function loadSelectedTeacher() {
            try {
                const saved = localStorage.getItem('selectedTeacher');
                if (saved && saved !== 'undefined' && saved !== 'null') {
                    const teacherData = JSON.parse(saved);
                    // Find the teacher in current teachers list to ensure it still exists
                    const teacher = teachersData.find(t => t.id === teacherData.id);
                    if (teacher) {
                        selectedTeacher = teacher;
                        document.getElementById('selectedTeacherName').textContent = teacher.name;
                        document.getElementById('calendarContainer').classList.remove('hidden');
                        document.getElementById('noTeacherSelected').classList.add('hidden');
                        console.log('Selected teacher loaded:', teacher.name);
                    } else {
                        console.log('Previously selected teacher no longer exists');
                    }
                } else {
                    console.log('No selected teacher found');
                }
            } catch (error) {
                console.error('Error loading selected teacher:', error);
            }
        }

        function updateMonthlyRecap() {
            if (!selectedTeacher) {
                document.getElementById('monthlyRecap').classList.add('hidden');
                return;
            }

            try {
                document.getElementById('monthlyRecap').classList.remove('hidden');
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 
                                  'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
                
                const monthlyStats = document.getElementById('monthlyStats');
                if (!monthlyStats) return;
                
                monthlyStats.innerHTML = '';
                
                let totalPercentage = 0;
                let monthsWithData = 0;
                
                for (let month = 0; month < 12; month++) {
                    const stats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
                    const prefix = `${selectedTeacher.id}-${currentYear}-${String(month + 1).padStart(2, '0')}`;
                    
                    Object.keys(attendanceData).forEach(key => {
                        if (key.startsWith(prefix)) {
                            const record = attendanceData[key];
                            const status = typeof record === 'string' ? record : record.status;
                            if (stats.hasOwnProperty(status)) {
                                stats[status]++;
                            }
                        }
                    });
                    
                    const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                    const totalPresent = stats.hadir + stats.terlambat;
                    const percentage = daysInMonth > 0 ? Math.round((totalPresent / daysInMonth) * 100) : 0;
                    
                    if (Object.values(stats).some(val => val > 0)) {
                        totalPercentage += percentage;
                        monthsWithData++;
                    }
                    
                    const monthCard = document.createElement('div');
                    monthCard.className = 'text-center p-4 rounded-lg border-2';
                    
                    // Color coding based on percentage
                    if (percentage >= 90) {
                        monthCard.classList.add('bg-green-50', 'border-green-200');
                    } else if (percentage >= 75) {
                        monthCard.classList.add('bg-yellow-50', 'border-yellow-200');
                    } else if (percentage > 0) {
                        monthCard.classList.add('bg-red-50', 'border-red-200');
                    } else {
                        monthCard.classList.add('bg-gray-50', 'border-gray-200');
                    }
                    
                    monthCard.innerHTML = `
                        <div class="text-sm font-medium text-gray-700 mb-1">${monthNames[month]}</div>
                        <div class="text-2xl font-bold ${percentage >= 90 ? 'text-green-600' : percentage >= 75 ? 'text-yellow-600' : percentage > 0 ? 'text-red-600' : 'text-gray-400'}">${percentage}%</div>
                        <div class="text-xs text-gray-500">${totalPresent}/${daysInMonth} hari</div>
                    `;
                    
                    monthlyStats.appendChild(monthCard);
                }
                
                const yearlyAverage = monthsWithData > 0 ? Math.round(totalPercentage / monthsWithData) : 0;
                const yearlyAverageElement = document.getElementById('yearlyAverage');
                if (yearlyAverageElement) {
                    yearlyAverageElement.textContent = `${yearlyAverage}%`;
                }
            } catch (error) {
                console.error('Monthly recap update error:', error);
            }
        }

        function showAddTeacher() {
            document.getElementById('addTeacherModal').classList.remove('hidden');
            document.getElementById('addTeacherModal').classList.add('flex');
        }

        function closeAddTeacher() {
            document.getElementById('addTeacherModal').classList.add('hidden');
            document.getElementById('addTeacherModal').classList.remove('flex');
            document.getElementById('newTeacherName').value = '';
            document.getElementById('newTeacherNIP').value = '';
            document.getElementById('newTeacherSubject').value = '';
        }

        function addTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            const nip = document.getElementById('newTeacherNIP').value.trim();
            const subject = document.getElementById('newTeacherSubject').value.trim();

            if (!name || !nip || !subject) {
                alert('Semua field harus diisi!');
                return;
            }

            updateSaveStatus('saving');
            const newId = Math.max(...teachersData.map(t => t.id), 0) + 1;
            teachersData.push({ id: newId, name, nip, subject });
            saveAllData();
            updateTeacherList();
            closeAddTeacher();
            updateSaveStatus('saved');
        }

        function deleteTeacher(id) {
            if (confirm('Yakin ingin menghapus guru ini?')) {
                updateSaveStatus('saving');
                teachersData = teachersData.filter(t => t.id !== id);
                if (selectedTeacher && selectedTeacher.id === id) {
                    selectedTeacher = null;
                    document.getElementById('selectedTeacherName').textContent = 'Belum dipilih';
                    document.getElementById('calendarContainer').classList.add('hidden');
                    document.getElementById('noTeacherSelected').classList.remove('hidden');
                    saveSelectedTeacher();
                }
                saveAllData();
                updateTeacherList();
                updateSaveStatus('saved');
            }
        }

        function importTeachers() {
            const csvData = prompt('Paste data guru dalam format CSV (Nama,NIP,Mata Pelajaran):');
            if (!csvData) return;

            updateSaveStatus('saving');
            const lines = csvData.trim().split('\n');
            let imported = 0;

            lines.forEach(line => {
                const [name, nip, subject] = line.split(',').map(s => s.trim());
                if (name && nip && subject) {
                    const newId = Math.max(...teachersData.map(t => t.id), 0) + 1;
                    teachersData.push({ id: newId, name, nip, subject });
                    imported++;
                }
            });

            if (imported > 0) {
                saveAllData();
                updateTeacherList();
                updateSaveStatus('saved');
                alert(`Berhasil mengimpor ${imported} guru!`);
            }
        }

        function updateCalendar() {
            if (!selectedTeacher) {
                document.getElementById('calendarContainer').classList.add('hidden');
                document.getElementById('noTeacherSelected').classList.remove('hidden');
                return;
            }

            try {
                console.log('=== UPDATE KALENDER ===');
                console.log('Selected teacher:', selectedTeacher.name, '(ID:', selectedTeacher.id + ')');
                
                currentMonth = parseInt(document.getElementById('monthSelect').value);
                currentYear = parseInt(document.getElementById('yearSelect').value);
                
                console.log('Period:', currentMonth + 1, '/', currentYear);
                
                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                                  'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                
                document.getElementById('calendarTitle').textContent = `${monthNames[currentMonth]} ${currentYear} - ${selectedTeacher.name}`;
                
                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                
                const calendarGrid = document.getElementById('calendarGrid');
                if (!calendarGrid) return;
                
                calendarGrid.innerHTML = '';
                
                // Cari semua data absensi untuk guru dan bulan ini
                const teacherPrefix = `${selectedTeacher.id}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const teacherAttendanceThisMonth = Object.keys(attendanceData).filter(key => 
                    key.startsWith(teacherPrefix)
                );
                
                console.log(`🔍 Mencari data dengan prefix: ${teacherPrefix}`);
                console.log(`📅 Ditemukan ${teacherAttendanceThisMonth.length} record untuk bulan ini`);
                
                if (teacherAttendanceThisMonth.length > 0) {
                    console.log('📋 Records ditemukan:');
                    teacherAttendanceThisMonth.forEach(key => {
                        console.log(`   ${key}: ${JSON.stringify(attendanceData[key])}`);
                    });
                }
                
                // Empty cells for days before month starts
                for (let i = 0; i < firstDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'h-16';
                    calendarGrid.appendChild(emptyCell);
                }
                
                // Days of the month
                let cellsWithData = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('div');
                    const dateKey = `${selectedTeacher.id}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const attendanceRecord = attendanceData[dateKey];
                    
                    cell.className = `calendar-cell h-16 border-2 border-gray-200 rounded-lg cursor-pointer flex flex-col items-center justify-center text-sm font-medium hover:shadow-md`;
                    
                    if (attendanceRecord) {
                        cellsWithData++;
                        const status = typeof attendanceRecord === 'string' ? attendanceRecord : attendanceRecord.status;
                        const note = typeof attendanceRecord === 'object' ? attendanceRecord.note : '';
                        
                        console.log(`📅 Day ${day}: ${status}${note ? ' (with note)' : ''}`);
                        
                        cell.classList.add(`status-${status}`);
                        cell.classList.add('text-white');
                        
                        cell.innerHTML = `
                            <span>${day}</span>
                            ${note ? '<span class="text-xs">📝</span>' : ''}
                        `;
                    } else {
                        cell.classList.add('hover:bg-gray-50');
                        cell.innerHTML = `<span>${day}</span>`;
                    }
                    
                    cell.onclick = () => openModal(dateKey, day);
                    
                    calendarGrid.appendChild(cell);
                }
                
                console.log(`✅ Kalender diupdate: ${cellsWithData} dari ${daysInMonth} hari memiliki data`);
                
                updateStatistics();
                console.log('=== SELESAI UPDATE KALENDER ===');
                
            } catch (error) {
                console.error('❌ Calendar update error:', error);
            }
        }

        let selectedStatus = null;

        function openModal(dateKey, day) {
            currentDate = dateKey;
            selectedStatus = null;
            
            document.getElementById('modalTitle').textContent = `Absensi Tanggal ${day} - ${selectedTeacher.name}`;
            
            // Check if there's existing data
            const existingData = attendanceData[dateKey];
            if (existingData) {
                const status = typeof existingData === 'string' ? existingData : existingData.status;
                const note = typeof existingData === 'object' ? existingData.note : '';
                
                // Show current status
                document.getElementById('currentStatus').classList.remove('hidden');
                document.getElementById('statusSelection').classList.add('hidden');
                document.getElementById('noteSection').classList.add('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
                
                const statusText = {
                    'hadir': 'Hadir',
                    'izin': 'Izin', 
                    'sakit': 'Sakit',
                    'alpha': 'Alpha',
                    'terlambat': 'Terlambat',
                    'pulang-cepat': 'Pulang Cepat'
                };
                
                document.getElementById('currentStatusText').textContent = statusText[status];
                document.getElementById('currentNote').textContent = note ? `Keterangan: ${note}` : '';
                
                // Set border color based on status
                const currentStatusDiv = document.getElementById('currentStatus');
                const colorMap = {
                    'hadir': 'border-green-400 bg-green-50',
                    'izin': 'border-yellow-400 bg-yellow-50',
                    'sakit': 'border-red-400 bg-red-50',
                    'alpha': 'border-gray-400 bg-gray-50',
                    'terlambat': 'border-purple-400 bg-purple-50',
                    'pulang-cepat': 'border-cyan-400 bg-cyan-50'
                };
                currentStatusDiv.className = `mb-4 p-3 rounded-lg border-l-4 ${colorMap[status]}`;
            } else {
                // Show status selection
                document.getElementById('currentStatus').classList.add('hidden');
                document.getElementById('statusSelection').classList.remove('hidden');
                document.getElementById('noteSection').classList.add('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
            }
            
            document.getElementById('attendanceModal').classList.remove('hidden');
            document.getElementById('attendanceModal').classList.add('flex');
        }

        function editCurrentStatus() {
            document.getElementById('currentStatus').classList.add('hidden');
            document.getElementById('statusSelection').classList.remove('hidden');
            
            // Pre-fill existing note if any
            const existingData = attendanceData[currentDate];
            if (existingData && typeof existingData === 'object' && existingData.note) {
                document.getElementById('attendanceNote').value = existingData.note;
            }
        }

        function selectStatus(status) {
            selectedStatus = status;
            document.getElementById('statusSelection').classList.add('hidden');
            document.getElementById('noteSection').classList.remove('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            
            // Focus on note input
            document.getElementById('attendanceNote').focus();
        }

        function saveAttendance() {
            if (!selectedStatus) {
                console.error('No status selected');
                return;
            }
            
            if (!currentDate) {
                console.error('No current date set');
                return;
            }
            
            console.log('=== MENYIMPAN ABSENSI ===');
            console.log('Date:', currentDate);
            console.log('Status:', selectedStatus);
            console.log('Teacher:', selectedTeacher ? selectedTeacher.name : 'None');
            
            updateSaveStatus('saving');
            
            const note = document.getElementById('attendanceNote').value.trim();
            
            // Simpan data absensi
            if (note) {
                attendanceData[currentDate] = {
                    status: selectedStatus,
                    note: note,
                    timestamp: new Date().toISOString()
                };
                console.log('Saved with note:', note);
            } else {
                attendanceData[currentDate] = selectedStatus;
                console.log('Saved without note');
            }
            
            // TRIPLE SAVE - Pastikan data tersimpan dengan 3 cara
            try {
                // 1. Simpan langsung ke localStorage
                const dataToSave = JSON.stringify(attendanceData);
                localStorage.setItem('attendanceData', dataToSave);
                console.log('✅ Step 1: Direct localStorage save - SUCCESS');
                
                // 2. Verifikasi data tersimpan
                const savedData = localStorage.getItem('attendanceData');
                const parsedData = JSON.parse(savedData);
                if (parsedData[currentDate]) {
                    console.log('✅ Step 2: Verification - Data found in localStorage');
                } else {
                    console.error('❌ Step 2: Verification - Data NOT found in localStorage');
                }
                
                // 3. Simpan melalui fungsi saveAllData
                saveAllData();
                console.log('✅ Step 3: saveAllData() called');
                
                // 4. Update UI
                updateCalendar();
                updateStatistics();
                updateMonthlyRecap();
                console.log('✅ Step 4: UI updated');
                
                // 5. Final verification
                setTimeout(() => {
                    const finalCheck = localStorage.getItem('attendanceData');
                    const finalParsed = JSON.parse(finalCheck);
                    if (finalParsed[currentDate]) {
                        console.log('✅ FINAL CHECK: Data masih ada di localStorage');
                        console.log('   Saved value:', finalParsed[currentDate]);
                    } else {
                        console.error('❌ FINAL CHECK: Data HILANG dari localStorage!');
                    }
                }, 100);
                
            } catch (error) {
                console.error('❌ Error during save process:', error);
                alert('Error menyimpan data: ' + error.message);
            }
            
            closeModal();
            updateSaveStatus('saved');
            
            console.log('=== SELESAI MENYIMPAN ABSENSI ===');
        }

        function closeModal() {
            document.getElementById('attendanceModal').classList.add('hidden');
            document.getElementById('attendanceModal').classList.remove('flex');
            
            // Reset form
            document.getElementById('attendanceNote').value = '';
            selectedStatus = null;
        }

        function clearAttendance() {
            updateSaveStatus('saving');
            delete attendanceData[currentDate];
            
            // Force immediate save
            try {
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                console.log('Attendance cleared immediately:', currentDate);
            } catch (error) {
                console.error('Error clearing attendance:', error);
            }
            
            saveAllData();
            updateCalendar();
            closeModal();
            updateSaveStatus('saved');
        }

        function updateStatistics() {
            if (!selectedTeacher) return;

            const stats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
            const prefix = `${selectedTeacher.id}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(prefix)) {
                    const record = attendanceData[key];
                    const status = typeof record === 'string' ? record : record.status;
                    if (stats.hasOwnProperty(status)) {
                        stats[status]++;
                    }
                }
            });
            
            document.getElementById('hadirCount').textContent = stats.hadir;
            document.getElementById('izinCount').textContent = stats.izin;
            document.getElementById('sakitCount').textContent = stats.sakit;
            document.getElementById('alphaCount').textContent = stats.alpha;
            document.getElementById('terlambatCount').textContent = stats.terlambat;
            document.getElementById('pulangCepatCount').textContent = stats['pulang-cepat'];

            const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();
            const totalPresent = stats.hadir + stats.terlambat;
            const percentage = totalDays > 0 ? Math.round((totalPresent / totalDays) * 100) : 0;
            document.getElementById('attendancePercentage').textContent = `${percentage}%`;
        }

        function saveData() {
            try {
                const dataToSave = JSON.stringify(attendanceData);
                localStorage.setItem('attendanceData', dataToSave);
                console.log('Attendance data saved to localStorage');
            } catch (error) {
                console.error('Error saving attendance data:', error);
            }
        }

        function loadData() {
            console.log('=== MEMUAT DATA ABSENSI ===');
            
            try {
                const saved = localStorage.getItem('attendanceData');
                console.log('Raw localStorage data length:', saved ? saved.length : 0);
                console.log('Raw data preview:', saved ? saved.substring(0, 200) + '...' : 'null');
                
                if (saved && saved !== 'undefined' && saved !== 'null' && saved.trim() !== '') {
                    const parsedData = JSON.parse(saved);
                    
                    if (typeof parsedData === 'object' && parsedData !== null) {
                        attendanceData = parsedData;
                        const recordCount = Object.keys(attendanceData).length;
                        
                        console.log('✅ Attendance data loaded successfully:', recordCount, 'records');
                        
                        if (recordCount > 0) {
                            console.log('📋 Sample data:');
                            Object.keys(attendanceData).slice(0, 5).forEach(key => {
                                console.log(`   ${key}: ${JSON.stringify(attendanceData[key])}`);
                            });
                            
                            // Analisis data per guru
                            const teacherStats = {};
                            Object.keys(attendanceData).forEach(key => {
                                const teacherId = key.split('-')[0];
                                if (!teacherStats[teacherId]) {
                                    teacherStats[teacherId] = 0;
                                }
                                teacherStats[teacherId]++;
                            });
                            
                            console.log('📊 Data per guru:');
                            Object.keys(teacherStats).forEach(teacherId => {
                                console.log(`   Guru ID ${teacherId}: ${teacherStats[teacherId]} records`);
                            });
                        }
                    } else {
                        attendanceData = {};
                        console.log('⚠️ Invalid data format, starting fresh');
                    }
                } else {
                    attendanceData = {};
                    console.log('ℹ️ No attendance data found, starting fresh');
                }
                
                // Verifikasi final
                console.log('📈 Final attendanceData object keys:', Object.keys(attendanceData).length);
                
            } catch (error) {
                console.error('❌ Error loading attendance data:', error);
                attendanceData = {};
                alert('Error memuat data absensi: ' + error.message);
            }
            
            console.log('=== SELESAI MEMUAT DATA ABSENSI ===');
        }

        function downloadPDF() {
            if (!selectedTeacher) {
                alert('Pilih guru terlebih dahulu!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            // Header
            doc.setFontSize(20);
            doc.text('LAPORAN ABSENSI GURU', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Nama: ${selectedTeacher.name}`, 20, 40);
            doc.text(`NIP: ${selectedTeacher.nip}`, 20, 50);
            doc.text(`Mata Pelajaran: ${selectedTeacher.subject}`, 20, 60);
            doc.text(`Periode: ${monthNames[currentMonth]} ${currentYear}`, 20, 70);
            
            // Table data
            const tableData = [];
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${selectedTeacher.id}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const attendanceRecord = attendanceData[dateKey];
                
                let status = '-';
                let note = '';
                
                if (attendanceRecord) {
                    status = typeof attendanceRecord === 'string' ? attendanceRecord : attendanceRecord.status;
                    note = typeof attendanceRecord === 'object' ? attendanceRecord.note || '' : '';
                }
                
                const statusText = {
                    'hadir': 'Hadir',
                    'izin': 'Izin',
                    'sakit': 'Sakit',
                    'alpha': 'Alpha',
                    'terlambat': 'Terlambat',
                    'pulang-cepat': 'Pulang Cepat'
                };
                
                tableData.push([day, statusText[status] || '-', note || '-']);
            }
            
            doc.autoTable({
                head: [['Tanggal', 'Status', 'Keterangan']],
                body: tableData,
                startY: 80,
                styles: { fontSize: 10 },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 'auto' }
                }
            });
            
            // Statistics
            const stats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
            const prefix = `${selectedTeacher.id}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(prefix)) {
                    const record = attendanceData[key];
                    const status = typeof record === 'string' ? record : record.status;
                    if (stats.hasOwnProperty(status)) {
                        stats[status]++;
                    }
                }
            });

            const finalY = doc.lastAutoTable.finalY + 20;
            doc.text('RINGKASAN:', 20, finalY);
            doc.text(`Hadir: ${stats.hadir} hari`, 20, finalY + 10);
            doc.text(`Izin: ${stats.izin} hari`, 20, finalY + 20);
            doc.text(`Sakit: ${stats.sakit} hari`, 20, finalY + 30);
            doc.text(`Alpha: ${stats.alpha} hari`, 20, finalY + 40);
            doc.text(`Terlambat: ${stats.terlambat} hari`, 20, finalY + 50);
            doc.text(`Pulang Cepat: ${stats['pulang-cepat']} hari`, 20, finalY + 60);
            
            const totalPresent = stats.hadir + stats.terlambat;
            const percentage = Math.round((totalPresent / daysInMonth) * 100);
            doc.text(`Persentase Kehadiran: ${percentage}%`, 20, finalY + 80);
            
            doc.save(`Absensi_${selectedTeacher.name.replace(/[^a-zA-Z0-9]/g, '_')}_${monthNames[currentMonth]}_${currentYear}.pdf`);
        }

        function exportToSpreadsheet() {
            if (!selectedTeacher) {
                alert('Pilih guru terlebih dahulu!');
                return;
            }

            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            let csvContent = `Laporan Absensi Guru\n`;
            csvContent += `Nama,${selectedTeacher.name}\n`;
            csvContent += `NIP,${selectedTeacher.nip}\n`;
            csvContent += `Mata Pelajaran,${selectedTeacher.subject}\n`;
            csvContent += `Periode,${monthNames[currentMonth]} ${currentYear}\n\n`;
            csvContent += `Tanggal,Status,Keterangan\n`;
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${selectedTeacher.id}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const attendanceRecord = attendanceData[dateKey];
                
                let status = '-';
                let note = '';
                
                if (attendanceRecord) {
                    status = typeof attendanceRecord === 'string' ? attendanceRecord : attendanceRecord.status;
                    note = typeof attendanceRecord === 'object' ? attendanceRecord.note || '' : '';
                }
                
                const statusText = {
                    'hadir': 'Hadir',
                    'izin': 'Izin',
                    'sakit': 'Sakit',
                    'alpha': 'Alpha',
                    'terlambat': 'Terlambat',
                    'pulang-cepat': 'Pulang Cepat'
                };
                
                csvContent += `${day},"${statusText[status] || '-'}","${note || '-'}"\n`;
            }
            
            // Statistics
            const stats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
            const prefix = `${selectedTeacher.id}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(prefix)) {
                    const record = attendanceData[key];
                    const status = typeof record === 'string' ? record : record.status;
                    if (stats.hasOwnProperty(status)) {
                        stats[status]++;
                    }
                }
            });
            
            csvContent += `\nRingkasan\n`;
            csvContent += `Hadir,${stats.hadir}\n`;
            csvContent += `Izin,${stats.izin}\n`;
            csvContent += `Sakit,${stats.sakit}\n`;
            csvContent += `Alpha,${stats.alpha}\n`;
            csvContent += `Terlambat,${stats.terlambat}\n`;
            csvContent += `Pulang Cepat,${stats['pulang-cepat']}\n`;
            
            const totalPresent = stats.hadir + stats.terlambat;
            const percentage = Math.round((totalPresent / daysInMonth) * 100);
            csvContent += `Persentase Kehadiran,${percentage}%\n`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Absensi_${selectedTeacher.name.replace(/[^a-zA-Z0-9]/g, '_')}_${monthNames[currentMonth]}_${currentYear}.csv`;
            link.click();
        }

        function backupData() {
            const backupData = {
                attendanceData: attendanceData,
                teachersData: teachersData,
                licenseExpire: localStorage.getItem('licenseExpire'),
                timestamp: new Date().toISOString(),
                version: '2.0'
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_absensi_pro_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            updateSaveStatus('saving');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (backupData.attendanceData && backupData.teachersData) {
                        attendanceData = backupData.attendanceData;
                        teachersData = backupData.teachersData;
                        selectedTeacher = null; // Reset selected teacher
                        
                        if (backupData.licenseExpire) {
                            localStorage.setItem('licenseExpire', backupData.licenseExpire);
                        }
                        
                        saveAllData();
                        updateTeacherList();
                        updateCalendar();
                        checkLicense();
                        updateSaveStatus('saved');
                        alert('Data berhasil dipulihkan!');
                    } else {
                        updateSaveStatus('error');
                        alert('Format file backup tidak valid!');
                    }
                } catch (error) {
                    updateSaveStatus('error');
                    alert('Error membaca file backup!');
                }
            };
            reader.readAsText(file);
        }

        function downloadMonthlyRecap() {
            if (!selectedTeacher) {
                alert('Pilih guru terlebih dahulu!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            // Header
            doc.setFontSize(20);
            doc.text('REKAP KEHADIRAN TAHUNAN', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Nama: ${selectedTeacher.name}`, 20, 40);
            doc.text(`NIP: ${selectedTeacher.nip}`, 20, 50);
            doc.text(`Mata Pelajaran: ${selectedTeacher.subject}`, 20, 60);
            doc.text(`Tahun: ${currentYear}`, 20, 70);
            
            // Monthly data table
            const tableData = [];
            let totalPercentage = 0;
            let monthsWithData = 0;
            
            for (let month = 0; month < 12; month++) {
                const stats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
                const prefix = `${selectedTeacher.id}-${currentYear}-${String(month + 1).padStart(2, '0')}`;
                
                Object.keys(attendanceData).forEach(key => {
                    if (key.startsWith(prefix)) {
                        const record = attendanceData[key];
                        const status = typeof record === 'string' ? record : record.status;
                        if (stats.hasOwnProperty(status)) {
                            stats[status]++;
                        }
                    }
                });
                
                const daysInMonth = new Date(currentYear, month + 1, 0).getDate();
                const totalPresent = stats.hadir + stats.terlambat;
                const percentage = daysInMonth > 0 ? Math.round((totalPresent / daysInMonth) * 100) : 0;
                
                if (Object.values(stats).some(val => val > 0)) {
                    totalPercentage += percentage;
                    monthsWithData++;
                }
                
                tableData.push([
                    monthNames[month],
                    stats.hadir,
                    stats.terlambat,
                    stats.izin,
                    stats.sakit,
                    stats.alpha,
                    stats['pulang-cepat'],
                    `${percentage}%`
                ]);
            }
            
            doc.autoTable({
                head: [['Bulan', 'Hadir', 'Terlambat', 'Izin', 'Sakit', 'Alpha', 'P.Cepat', 'Persentase']],
                body: tableData,
                startY: 80,
                styles: { fontSize: 9 },
                columnStyles: {
                    0: { cellWidth: 25 },
                    7: { cellWidth: 20, halign: 'center' }
                }
            });
            
            // Summary
            const finalY = doc.lastAutoTable.finalY + 20;
            const yearlyAverage = monthsWithData > 0 ? Math.round(totalPercentage / monthsWithData) : 0;
            
            doc.setFontSize(14);
            doc.text('RINGKASAN TAHUNAN:', 20, finalY);
            doc.setFontSize(12);
            doc.text(`Rata-rata Kehadiran: ${yearlyAverage}%`, 20, finalY + 15);
            doc.text(`Bulan dengan Data: ${monthsWithData} dari 12 bulan`, 20, finalY + 25);
            
            // Performance indicator
            let performance = 'Perlu Perhatian';
            if (yearlyAverage >= 90) performance = 'Sangat Baik';
            else if (yearlyAverage >= 75) performance = 'Baik';
            
            doc.text(`Kategori Kinerja: ${performance}`, 20, finalY + 35);
            
            doc.save(`Rekap_Tahunan_${selectedTeacher.name.replace(/[^a-zA-Z0-9]/g, '_')}_${currentYear}.pdf`);
        }

        // All Teachers Recap Functions
        function showAllTeachersRecap() {
            document.getElementById('recapMonthSelect').value = currentMonth;
            document.getElementById('recapYearSelect').value = currentYear;
            updateAllTeachersRecap();
            document.getElementById('allTeachersModal').classList.remove('hidden');
            document.getElementById('allTeachersModal').classList.add('flex');
        }

        function closeAllTeachersRecap() {
            document.getElementById('allTeachersModal').classList.add('hidden');
            document.getElementById('allTeachersModal').classList.remove('flex');
        }

        function updateAllTeachersRecap() {
            const recapMonth = parseInt(document.getElementById('recapMonthSelect').value);
            const recapYear = parseInt(document.getElementById('recapYearSelect').value);
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const tableBody = document.getElementById('allTeachersTableBody');
            const daysInMonth = new Date(recapYear, recapMonth + 1, 0).getDate();
            
            // Initialize totals
            let totalStats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
            let allTeachersData = [];
            let totalPercentage = 0;
            let teachersWithData = 0;
            let bestTeacher = { name: '-', percentage: 0 };
            let teachersNeedAttention = 0;
            
            // Clear table
            tableBody.innerHTML = '';
            
            // Process each teacher
            teachersData.forEach((teacher, index) => {
                const stats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
                const prefix = `${teacher.id}-${recapYear}-${String(recapMonth + 1).padStart(2, '0')}`;
                
                // Count attendance for this teacher
                Object.keys(attendanceData).forEach(key => {
                    if (key.startsWith(prefix)) {
                        const record = attendanceData[key];
                        const status = typeof record === 'string' ? record : record.status;
                        if (stats.hasOwnProperty(status)) {
                            stats[status]++;
                            totalStats[status]++;
                        }
                    }
                });
                
                const totalPresent = stats.hadir + stats.terlambat;
                const percentage = daysInMonth > 0 ? Math.round((totalPresent / daysInMonth) * 100) : 0;
                
                // Track statistics
                if (Object.values(stats).some(val => val > 0)) {
                    totalPercentage += percentage;
                    teachersWithData++;
                }
                
                if (percentage > bestTeacher.percentage) {
                    bestTeacher = { name: teacher.name, percentage: percentage };
                }
                
                if (percentage < 75 && Object.values(stats).some(val => val > 0)) {
                    teachersNeedAttention++;
                }
                
                allTeachersData.push({
                    teacher: teacher,
                    stats: stats,
                    percentage: percentage
                });
                
                // Create table row
                const row = document.createElement('tr');
                row.className = percentage < 75 && Object.values(stats).some(val => val > 0) ? 'bg-red-50' : 
                               percentage >= 90 ? 'bg-green-50' : 
                               percentage >= 75 ? 'bg-yellow-50' : '';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${index + 1}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${teacher.name}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${teacher.nip}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${teacher.subject}</td>
                    <td class="px-4 py-3 text-sm text-center text-green-600 font-semibold">${stats.hadir}</td>
                    <td class="px-4 py-3 text-sm text-center text-yellow-600 font-semibold">${stats.izin}</td>
                    <td class="px-4 py-3 text-sm text-center text-red-600 font-semibold">${stats.sakit}</td>
                    <td class="px-4 py-3 text-sm text-center text-gray-600 font-semibold">${stats.alpha}</td>
                    <td class="px-4 py-3 text-sm text-center text-purple-600 font-semibold">${stats.terlambat}</td>
                    <td class="px-4 py-3 text-sm text-center text-cyan-600 font-semibold">${stats['pulang-cepat']}</td>
                    <td class="px-4 py-3 text-sm text-center font-bold ${
                        percentage >= 90 ? 'text-green-600' : 
                        percentage >= 75 ? 'text-yellow-600' : 
                        percentage > 0 ? 'text-red-600' : 'text-gray-400'
                    }">${percentage}%</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update summary cards
            document.getElementById('totalTeachersCount').textContent = teachersData.length;
            document.getElementById('totalHadirAll').textContent = totalStats.hadir;
            document.getElementById('totalIzinAll').textContent = totalStats.izin;
            document.getElementById('totalSakitAll').textContent = totalStats.sakit;
            document.getElementById('totalAlphaAll').textContent = totalStats.alpha;
            document.getElementById('totalTerlambatAll').textContent = totalStats.terlambat;
            document.getElementById('totalPulangCepatAll').textContent = totalStats['pulang-cepat'];
            
            // Update overall statistics
            const overallRate = teachersWithData > 0 ? Math.round(totalPercentage / teachersWithData) : 0;
            document.getElementById('overallAttendanceRate').textContent = `${overallRate}%`;
            document.getElementById('bestPerformingTeacher').textContent = bestTeacher.name;
            document.getElementById('teachersNeedAttention').textContent = teachersNeedAttention;
        }

        function downloadAllTeachersPDF() {
            const recapMonth = parseInt(document.getElementById('recapMonthSelect').value);
            const recapYear = parseInt(document.getElementById('recapYearSelect').value);
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Header
            doc.setFontSize(18);
            doc.text('REKAP KEHADIRAN SEMUA GURU', 148, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Periode: ${monthNames[recapMonth]} ${recapYear}`, 20, 35);
            doc.text(`Total Guru: ${teachersData.length} orang`, 20, 45);
            doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 200, 35);
            
            // Prepare table data
            const tableData = [];
            let totalStats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
            let totalPercentage = 0;
            let teachersWithData = 0;
            const daysInMonth = new Date(recapYear, recapMonth + 1, 0).getDate();
            
            teachersData.forEach((teacher, index) => {
                const stats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
                const prefix = `${teacher.id}-${recapYear}-${String(recapMonth + 1).padStart(2, '0')}`;
                
                Object.keys(attendanceData).forEach(key => {
                    if (key.startsWith(prefix)) {
                        const record = attendanceData[key];
                        const status = typeof record === 'string' ? record : record.status;
                        if (stats.hasOwnProperty(status)) {
                            stats[status]++;
                            totalStats[status]++;
                        }
                    }
                });
                
                const totalPresent = stats.hadir + stats.terlambat;
                const percentage = daysInMonth > 0 ? Math.round((totalPresent / daysInMonth) * 100) : 0;
                
                if (Object.values(stats).some(val => val > 0)) {
                    totalPercentage += percentage;
                    teachersWithData++;
                }
                
                tableData.push([
                    index + 1,
                    teacher.name,
                    teacher.nip,
                    teacher.subject,
                    stats.hadir,
                    stats.izin,
                    stats.sakit,
                    stats.alpha,
                    stats.terlambat,
                    stats['pulang-cepat'],
                    `${percentage}%`
                ]);
            });
            
            // Add table
            doc.autoTable({
                head: [['No', 'Nama Guru', 'NIP', 'Mata Pelajaran', 'Hadir', 'Izin', 'Sakit', 'Alpha', 'Terlambat', 'P.Cepat', '%']],
                body: tableData,
                startY: 55,
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 35 },
                    4: { cellWidth: 15, halign: 'center' },
                    5: { cellWidth: 15, halign: 'center' },
                    6: { cellWidth: 15, halign: 'center' },
                    7: { cellWidth: 15, halign: 'center' },
                    8: { cellWidth: 20, halign: 'center' },
                    9: { cellWidth: 20, halign: 'center' },
                    10: { cellWidth: 15, halign: 'center' }
                }
            });
            
            // Summary
            const finalY = doc.lastAutoTable.finalY + 15;
            const overallRate = teachersWithData > 0 ? Math.round(totalPercentage / teachersWithData) : 0;
            
            doc.setFontSize(12);
            doc.text('RINGKASAN:', 20, finalY);
            doc.text(`Total Hadir: ${totalStats.hadir}`, 20, finalY + 10);
            doc.text(`Total Izin: ${totalStats.izin}`, 80, finalY + 10);
            doc.text(`Total Sakit: ${totalStats.sakit}`, 140, finalY + 10);
            doc.text(`Total Alpha: ${totalStats.alpha}`, 200, finalY + 10);
            doc.text(`Total Terlambat: ${totalStats.terlambat}`, 20, finalY + 20);
            doc.text(`Total Pulang Cepat: ${totalStats['pulang-cepat']}`, 80, finalY + 20);
            doc.text(`Rata-rata Kehadiran: ${overallRate}%`, 140, finalY + 20);
            
            doc.save(`Rekap_Semua_Guru_${monthNames[recapMonth]}_${recapYear}.pdf`);
        }

        function exportAllTeachersCSV() {
            const recapMonth = parseInt(document.getElementById('recapMonthSelect').value);
            const recapYear = parseInt(document.getElementById('recapYearSelect').value);
            const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                              'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            let csvContent = `Rekap Kehadiran Semua Guru\n`;
            csvContent += `Periode,${monthNames[recapMonth]} ${recapYear}\n`;
            csvContent += `Total Guru,${teachersData.length}\n`;
            csvContent += `Tanggal Cetak,${new Date().toLocaleDateString('id-ID')}\n\n`;
            csvContent += `No,Nama Guru,NIP,Mata Pelajaran,Hadir,Izin,Sakit,Alpha,Terlambat,Pulang Cepat,Persentase\n`;
            
            let totalStats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
            let totalPercentage = 0;
            let teachersWithData = 0;
            const daysInMonth = new Date(recapYear, recapMonth + 1, 0).getDate();
            
            teachersData.forEach((teacher, index) => {
                const stats = { hadir: 0, izin: 0, sakit: 0, alpha: 0, terlambat: 0, 'pulang-cepat': 0 };
                const prefix = `${teacher.id}-${recapYear}-${String(recapMonth + 1).padStart(2, '0')}`;
                
                Object.keys(attendanceData).forEach(key => {
                    if (key.startsWith(prefix)) {
                        const record = attendanceData[key];
                        const status = typeof record === 'string' ? record : record.status;
                        if (stats.hasOwnProperty(status)) {
                            stats[status]++;
                            totalStats[status]++;
                        }
                    }
                });
                
                const totalPresent = stats.hadir + stats.terlambat;
                const percentage = daysInMonth > 0 ? Math.round((totalPresent / daysInMonth) * 100) : 0;
                
                if (Object.values(stats).some(val => val > 0)) {
                    totalPercentage += percentage;
                    teachersWithData++;
                }
                
                csvContent += `${index + 1},"${teacher.name}","${teacher.nip}","${teacher.subject}",${stats.hadir},${stats.izin},${stats.sakit},${stats.alpha},${stats.terlambat},${stats['pulang-cepat']},${percentage}%\n`;
            });
            
            // Add summary
            const overallRate = teachersWithData > 0 ? Math.round(totalPercentage / teachersWithData) : 0;
            csvContent += `\nRingkasan\n`;
            csvContent += `Total Hadir,${totalStats.hadir}\n`;
            csvContent += `Total Izin,${totalStats.izin}\n`;
            csvContent += `Total Sakit,${totalStats.sakit}\n`;
            csvContent += `Total Alpha,${totalStats.alpha}\n`;
            csvContent += `Total Terlambat,${totalStats.terlambat}\n`;
            csvContent += `Total Pulang Cepat,${totalStats['pulang-cepat']}\n`;
            csvContent += `Rata-rata Kehadiran,${overallRate}%\n`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Rekap_Semua_Guru_${monthNames[recapMonth]}_${recapYear}.csv`;
            link.click();
        }

        // Test function untuk memastikan save/load berfungsi
        function testSaveLoad() {
            if (!selectedTeacher) {
                alert('Pilih guru terlebih dahulu untuk test!');
                return;
            }
            
            console.log('=== TEST SAVE/LOAD FUNCTION ===');
            
            // Test data
            const testDate = `${selectedTeacher.id}-${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-15`;
            const testStatus = 'hadir';
            const testNote = 'Test save/load - ' + new Date().toLocaleTimeString();
            
            console.log('🧪 Testing with:');
            console.log('   Date key:', testDate);
            console.log('   Status:', testStatus);
            console.log('   Note:', testNote);
            
            // Step 1: Save test data
            attendanceData[testDate] = {
                status: testStatus,
                note: testNote,
                timestamp: new Date().toISOString()
            };
            
            console.log('✅ Step 1: Data added to memory');
            
            // Step 2: Save to localStorage
            try {
                localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                console.log('✅ Step 2: Data saved to localStorage');
            } catch (error) {
                console.error('❌ Step 2 FAILED:', error);
                alert('GAGAL menyimpan ke localStorage: ' + error.message);
                return;
            }
            
            // Step 3: Clear memory and reload
            const originalData = {...attendanceData};
            attendanceData = {};
            console.log('🔄 Step 3: Memory cleared');
            
            // Step 4: Load from localStorage
            loadData();
            console.log('✅ Step 4: Data reloaded from localStorage');
            
            // Step 5: Verify test data exists
            if (attendanceData[testDate]) {
                const loadedData = attendanceData[testDate];
                console.log('✅ Step 5: Test data found after reload!');
                console.log('   Loaded data:', loadedData);
                
                // Update calendar to show the test data
                updateCalendar();
                
                alert(`✅ TEST BERHASIL!

Data berhasil disimpan dan dimuat kembali:
- Tanggal: ${testDate}
- Status: ${loadedData.status}
- Note: ${loadedData.note}

Lihat tanggal 15 di kalender - seharusnya berwarna hijau (hadir).`);
                
            } else {
                console.error('❌ Step 5 FAILED: Test data NOT found after reload');
                alert('❌ TEST GAGAL! Data tidak ditemukan setelah reload.');
                
                // Restore original data
                attendanceData = originalData;
                updateCalendar();
            }
            
            console.log('=== END TEST SAVE/LOAD ===');
        }

        // Debug function to check data storage
        function debugData() {
            // Test save and load
            const testKey = 'test-attendance-' + Date.now();
            const testValue = 'hadir';
            
            try {
                // Test write
                localStorage.setItem(testKey, testValue);
                const readBack = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                console.log('Storage test - Write:', testValue, 'Read:', readBack, 'Success:', testValue === readBack);
            } catch (error) {
                console.error('Storage test failed:', error);
            }
            
            const debugInfo = {
                localStorage: {
                    attendanceData: localStorage.getItem('attendanceData'),
                    attendanceDataLength: localStorage.getItem('attendanceData') ? localStorage.getItem('attendanceData').length : 0,
                    teachersData: localStorage.getItem('teachersData'),
                    selectedTeacher: localStorage.getItem('selectedTeacher'),
                    lastSaveTime: localStorage.getItem('lastSaveTime')
                },
                memory: {
                    attendanceData: attendanceData,
                    attendanceDataSample: Object.keys(attendanceData).slice(0, 5).map(key => ({key, value: attendanceData[key]})),
                    teachersData: teachersData,
                    selectedTeacher: selectedTeacher,
                    attendanceCount: Object.keys(attendanceData).length,
                    teachersCount: teachersData.length
                },
                browser: {
                    userAgent: navigator.userAgent,
                    cookieEnabled: navigator.cookieEnabled,
                    storageQuota: 'Checking...'
                }
            };
            
            // Check storage quota
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    debugInfo.browser.storageQuota = `${Math.round(estimate.usage / 1024)} KB used of ${Math.round(estimate.quota / 1024 / 1024)} MB`;
                    console.log('Debug Info:', debugInfo);
                    alert(`Debug Info (lihat console untuk detail lengkap):
                    
Data Absensi: ${debugInfo.memory.attendanceCount} records
Data Guru: ${debugInfo.memory.teachersCount} teachers
Guru Terpilih: ${debugInfo.memory.selectedTeacher ? debugInfo.memory.selectedTeacher.name : 'None'}
Storage: ${debugInfo.browser.storageQuota}

Cek console browser (F12) untuk detail lengkap!`);
                });
            } else {
                console.log('Debug Info:', debugInfo);
                alert(`Debug Info (lihat console untuk detail lengkap):
                
Data Absensi: ${debugInfo.memory.attendanceCount} records
Data Guru: ${debugInfo.memory.teachersCount} teachers
Guru Terpilih: ${debugInfo.memory.selectedTeacher ? debugInfo.memory.selectedTeacher.name : 'None'}

Cek console browser (F12) untuk detail lengkap!`);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96bb51efd20b9cbd',t:'MTc1NDYxNzM3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
